{% extends "base.html" %}

{% block content %}

<div class="container">
  <div class="row">
    <a class="post" href="/form_hours">Bæta við færslu</a>
  </div>
</div>

<form class="query" method="get">
  <div class="column">
    <label for="client" class="">Kúnni</label>
    <select id="client" name="client_id" onchange="loadProjects()">
      <option value=""></option>
      {% for c in clients %}
      <option value="{{ c.id }}" {% if c.id == query[0] %}selected{% endif %}>{{ c.name }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="column">
    <label for="project">Verkefni</label>
    <select id="project" name="project_id"></select>
  </div>

  <div class="column">
    <label for="date">Byrjun tímabils</label>
    <input type="date" name="start_date" id="start_date" value="{{ query[2] }}"/>
  </div>

  <div class="column">
    <label for="date">Lok tímabils</label>
    <input type="date" name="end_date" id="end_date" value="{{ query[3] }}"/>
  </div>

  <div class="column last">
    <button class="get">Sækja</button>
  </div>
</form>

{% if hours %}
<table class="rwd-table">
  <thead>
  <tr>
    <th class="data-label">Dags.</th>
    <th class="data-label">Kúnni</th>
    <th class="data-label">Verkefni</th>
    <th class="data-label">Klst.</th>
    <th class="data-label">Lýsing</th>
    <th class="last"><a href="/download" class="save">Vista</a></th>
  </tr>
  </thead>
  <tbody>
  {% for h in hours %}
  <tr>
    <td data-label="Dags.">{{ h.date }}</td>
    <td data-label="Kúnni">{{ h.client.name }}</td>
    <td data-label="Verkefni">{{ h.project.description or "-" }}</td>
    <td data-label="Klst.">{{ h.hours }}</td>
    <td data-label="Útkall">{% if h.call %}Já{% else %}Nei{% endif %}</td>
    <td data-label="Lýsing">{{ h.description or "-" }}</td>
    <td>
      <div class="last">
        <form method="POST"
              action="{{ url_for('hours.delete_item', id=h.id) }}"
              onsubmit="return confirm('Eyða þessari færslu?\n {{h.date}}\n {{h.client.name}}\n {{ h.project.description}}\n {{h.hours}}\n {% if h.call %}Útkall{%else%}Ekki útkall{% endif %}\n {{h.description}}');">
          <button type="submit" class="delete">Eyða</button>
        </form>
        <form  action="{{ url_for('hours.edit', id=h.id) }}">
          <button type="submit" class="edit">Breyta</button>
        </form>
      </div>
    </td>
  </tr>
  {% endfor %}
  </tbody>
</table>
{% else %}
<p>Engir tímar skráðir.</p>
{% endif %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    loadProjects();
  }); 

  function loadProjects() {
    const clientId = document.getElementById('client').value;
    const projectSelect = document.getElementById('project');  
    projectSelect.innerHTML = '<option value=""></option>';

    if (!clientId) return;

    fetch('/api/projects?client_id=' + clientId)
      .then(res => res.json())
      .then(data => {
        data
          .sort((a, b) => a.description.localeCompare(b.description))
          .forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.description;
            {% if query[1] %}
            if ( p.id == {{ query[1] }}) { opt.selected = true; }
            {% endif %}
            projectSelect.appendChild(opt);
          });
      });
  }
</script>
{% endblock %}
